<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>ê°•ë‚¨êµ¬ ë³´ì•ˆë“± ìœ„ì¹˜ ì§€ë„</title>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family: "Malgun Gothic", sans-serif;
      }
      #map {
        width: 100%;
        height: 100vh;
      }
      #info {
        position: absolute;
        top: 10px;
        left: 10px;
        background: white;
        padding: 15px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        z-index: 1;
        max-width: 300px;
      }
      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 20px 40px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        z-index: 2;
        font-size: 18px;
      }
      .hidden {
        display: none;
      }
      #controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 10px;
        border-radius: 5px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        z-index: 1;
      }
      button {
        padding: 8px 15px;
        margin: 5px;
        cursor: pointer;
        border: none;
        background: #ff9800;
        color: white;
        border-radius: 4px;
        font-size: 14px;
      }
      button:hover {
        background: #f57c00;
      }
      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }
      h3 {
        margin: 0 0 10px 0;
        color: #333;
      }
      p {
        margin: 5px 0;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div id="loading">ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div id="info">
      <h3>ğŸ”¦ ê°•ë‚¨êµ¬ ë³´ì•ˆë“±</h3>
      <p>ì „ì²´ ë³´ì•ˆë“±: <span id="total">0</span>ê°œ</p>
      <p>í‘œì‹œëœ ë§ˆì»¤: <span id="displayed">0</span>ê°œ</p>
      <p style="font-size: 12px; color: #999; margin-top: 10px">
        â€» í´ëŸ¬ìŠ¤í„°ë¥¼ í´ë¦­í•˜ë©´ í™•ëŒ€ë©ë‹ˆë‹¤
      </p>
    </div>
    <div id="controls">
      <button onclick="toggleMarkers()">ë§ˆì»¤ í† ê¸€</button>
      <button onclick="resetMap()">ì§€ë„ ì´ˆê¸°í™”</button>
    </div>
    <div id="map"></div>

    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=04bd479933893a7050c82bf667702a4b&libraries=clusterer"
    ></script>
    <script>
      let map;
      let clusterer;
      let markers = [];
      let markersVisible = true;

      // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
      function initMap() {
        const container = document.getElementById("map");
        const options = {
          center: new kakao.maps.LatLng(37.4979, 127.0276), // ê°•ë‚¨êµ¬ ì¤‘ì‹¬
          level: 6,
        };

        map = new kakao.maps.Map(container, options);

        // ë§ˆì»¤ í´ëŸ¬ìŠ¤í„°ëŸ¬ ìƒì„±
        clusterer = new kakao.maps.MarkerClusterer({
          map: map,
          averageCenter: true,
          minLevel: 4,
          disableClickZoom: false,
          styles: [
            {
              width: "53px",
              height: "52px",
              background: "rgba(255, 152, 0, .8)",
              borderRadius: "25px",
              color: "#fff",
              textAlign: "center",
              fontWeight: "bold",
              lineHeight: "54px",
            },
          ],
        });
      }

      // CSV íŒŒì¼ íŒŒì‹± í•¨ìˆ˜
      function parseCSVLine(line) {
        const result = [];
        let current = "";
        let inQuotes = false;

        for (let i = 0; i < line.length; i++) {
          const char = line[i];

          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === "," && !inQuotes) {
            result.push(current.trim());
            current = "";
          } else {
            current += char;
          }
        }
        result.push(current.trim());
        return result;
      }

      // CSV íŒŒì¼ ì½ê¸°
      async function loadCSV() {
        try {
          const response = await fetch(
            "ì„œìš¸íŠ¹ë³„ì‹œ_ê°•ë‚¨êµ¬_ë³´ì•ˆë“±ì •ë³´_20250103.csv",
          );
          const text = await response.text();
          const lines = text.trim().split("\n");

          // í—¤ë” ì œì™¸
          const dataLines = lines.slice(1);
          document.getElementById("total").textContent =
            dataLines.length.toLocaleString();

          // ë§ˆì»¤ ìƒì„±
          const markerList = [];
          let count = 0;
          const uniquePositions = new Set();

          for (const line of dataLines) {
            const columns = parseCSVLine(line);

            // ìœ„ë„(4ë²ˆ ì¸ë±ìŠ¤), ê²½ë„(5ë²ˆ ì¸ë±ìŠ¤)
            const latitude = parseFloat(columns[4]);
            const longitude = parseFloat(columns[5]);

            if (!isNaN(latitude) && !isNaN(longitude)) {
              const posKey = `${latitude},${longitude}`;
              uniquePositions.add(posKey);

              const marker = new kakao.maps.Marker({
                position: new kakao.maps.LatLng(latitude, longitude),
                image: new kakao.maps.MarkerImage(
                  "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png",
                  new kakao.maps.Size(20, 28),
                  { offset: new kakao.maps.Point(10, 28) },
                ),
              });

              // ë§ˆì»¤ì— ì •ë³´ì°½ ì¶”ê°€
              const infowindow = new kakao.maps.InfoWindow({
                content: `<div style="padding:5px;font-size:12px;width:200px;">
                                        <strong>${columns[0]}</strong><br>
                                        ${columns[3]}<br>
                                        <span style="color:#666;">ì„¤ì¹˜ì—°ë„: ${columns[6]}, ${columns[7]}</span>
                                      </div>`,
              });

              // ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
              kakao.maps.event.addListener(marker, "click", function () {
                infowindow.open(map, marker);
              });

              markerList.push(marker);
              count++;

              // ì§„í–‰ ìƒí™© í‘œì‹œ (1000ê°œë§ˆë‹¤)
              if (count % 1000 === 0) {
                document.getElementById("displayed").textContent =
                  count.toLocaleString();
              }
            }
          }

          markers = markerList;
          document.getElementById("displayed").textContent =
            count.toLocaleString();

          // í´ëŸ¬ìŠ¤í„°ëŸ¬ì— ë§ˆì»¤ ì¶”ê°€
          clusterer.addMarkers(markers);

          // ë¡œë”© ë©”ì‹œì§€ ìˆ¨ê¹€
          document.getElementById("loading").classList.add("hidden");

          console.log(`ì´ ${count}ê°œì˜ ë³´ì•ˆë“± ë§ˆì»¤ê°€ í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤.`);
          console.log(`ê³ ìœ  ìœ„ì¹˜ ìˆ˜: ${uniquePositions.size}ê°œ`);
        } catch (error) {
          console.error("CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
          alert(
            "CSV íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\níŒŒì¼ëª…: ì„œìš¸íŠ¹ë³„ì‹œ_ê°•ë‚¨êµ¬_ë³´ì•ˆë“±ì •ë³´_20250103.csv",
          );
          document.getElementById("loading").textContent = "ì˜¤ë¥˜ ë°œìƒ!";
        }
      }

      // ë§ˆì»¤ í† ê¸€
      function toggleMarkers() {
        if (markersVisible) {
          clusterer.clear();
          markersVisible = false;
        } else {
          clusterer.addMarkers(markers);
          markersVisible = true;
        }
      }

      // ì§€ë„ ì´ˆê¸°í™”
      function resetMap() {
        map.setCenter(new kakao.maps.LatLng(37.4979, 127.0276));
        map.setLevel(6);
      }

      // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
      window.onload = function () {
        // ì¹´ì¹´ì˜¤ë§µ API ë¡œë“œ í™•ì¸
        if (typeof kakao === "undefined") {
          alert("ì¹´ì¹´ì˜¤ë§µ APIë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
          document.getElementById("loading").textContent = "API ë¡œë“œ ì‹¤íŒ¨!";
          return;
        }

        kakao.maps.load(function () {
          initMap();
          loadCSV();
        });
      };
    </script>
  </body>
</html>
