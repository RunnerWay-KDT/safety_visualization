<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <title>ğŸ›¡ï¸ ì—­ì‚¼ì—­ ì‚°ì±…ê²½ë¡œ ì•ˆì „ì ìˆ˜ ì‹œê°í™”</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }
      body {
        font-family: "Malgun Gothic", "Apple SD Gothic Neo", sans-serif;
        background: #f4f6f8;
      }

      /* â”€â”€ ë ˆì´ì•„ì›ƒ â”€â”€ */
      #header {
        background: linear-gradient(135deg, #1a237e, #283593);
        color: #fff;
        padding: 16px 24px;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      #header h1 {
        font-size: 20px;
      }
      #header .badge {
        font-size: 28px;
        font-weight: bold;
        background: rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        padding: 6px 18px;
      }

      #main {
        display: flex;
        height: calc(100vh - 60px);
      }
      #sidebar {
        width: 380px;
        overflow-y: auto;
        padding: 16px;
        background: #fff;
        border-right: 1px solid #e0e0e0;
      }
      #map-wrap {
        flex: 1;
        position: relative;
      }
      #map {
        width: 100%;
        height: 100%;
      }

      /* â”€â”€ ì¹´ë“œ â”€â”€ */
      .card {
        background: #fff;
        border: 1px solid #e8e8e8;
        border-radius: 10px;
        padding: 16px;
        margin-bottom: 14px;
        box-shadow: 0 1px 4px rgba(0, 0, 0, 0.06);
      }
      .card h3 {
        font-size: 14px;
        color: #555;
        margin-bottom: 10px;
        border-bottom: 1px solid #eee;
        padding-bottom: 6px;
      }
      .card .row {
        display: flex;
        justify-content: space-between;
        margin: 6px 0;
        font-size: 13px;
      }
      .card .label {
        color: #888;
      }
      .card .value {
        font-weight: bold;
        color: #333;
      }

      /* ì ìˆ˜ ê²Œì´ì§€ */
      .gauge-wrap {
        text-align: center;
        margin: 10px 0;
      }
      .gauge-bar {
        width: 100%;
        height: 26px;
        background: #eee;
        border-radius: 13px;
        overflow: hidden;
        position: relative;
      }
      .gauge-fill {
        height: 100%;
        border-radius: 13px;
        transition: width 1.5s ease;
      }
      .gauge-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: bold;
        color: #333;
        font-size: 13px;
      }

      /* ë²”ë¡€ */
      .legend-item {
        display: flex;
        align-items: center;
        margin: 4px 0;
        font-size: 12px;
      }
      .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
      }
      .legend-line {
        width: 24px;
        height: 4px;
        border-radius: 2px;
        margin-right: 8px;
        flex-shrink: 0;
      }

      /* ìˆ˜ì‹ */
      .formula {
        background: #f8f9fa;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 12px;
        font-family: "Consolas", monospace;
        font-size: 12px;
        line-height: 1.8;
        color: #333;
      }
      .formula .highlight {
        color: #d32f2f;
        font-weight: bold;
      }
      .formula .blue {
        color: #1565c0;
        font-weight: bold;
      }
      .formula .green {
        color: #2e7d32;
        font-weight: bold;
      }

      /* í† ê¸€ ë ˆì´ì–´ */
      #layer-controls {
        position: absolute;
        top: 10px;
        right: 10px;
        background: white;
        padding: 12px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 5;
        font-size: 13px;
      }
      #layer-controls label {
        display: block;
        margin: 4px 0;
        cursor: pointer;
      }
      #layer-controls input {
        margin-right: 6px;
      }

      /* ë¡œë”© */
      #loading {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.92);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 999;
        font-size: 20px;
        color: #333;
      }
      .hidden {
        display: none !important;
      }

      /* í”„ë¡œì„¸ìŠ¤ ë‹¨ê³„ */
      .step {
        margin-bottom: 6px;
      }
      .step-num {
        display: inline-block;
        width: 22px;
        height: 22px;
        background: #1a237e;
        color: #fff;
        border-radius: 50%;
        text-align: center;
        line-height: 22px;
        font-size: 11px;
        margin-right: 6px;
      }
      .step-label {
        font-size: 13px;
        color: #444;
      }
    </style>
  </head>
  <body>
    <div id="loading">ğŸ“Š ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <div id="header">
      <h1>ğŸ›¡ï¸ ì—­ì‚¼ì—­ ì‚°ì±…ê²½ë¡œ ì•ˆì „ì ìˆ˜ ë¶„ì„</h1>
      <div class="badge" id="score-badge">-- ì </div>
    </div>

    <div id="main">
      <!-- â”€â”€â”€ ì‚¬ì´ë“œë°” â”€â”€â”€ -->
      <div id="sidebar">
        <!-- ì¢…í•© ì ìˆ˜ -->
        <div class="card">
          <h3>ğŸ“Š ì¢…í•© ì•ˆì „ ì ìˆ˜</h3>
          <div class="gauge-wrap">
            <div class="gauge-bar">
              <div class="gauge-fill" id="gauge-fill" style="width: 0%"></div>
              <div class="gauge-text" id="gauge-text">0ì </div>
            </div>
          </div>
          <div class="row">
            <span class="label">ê²½ë¡œ ê¸¸ì´</span
            ><span class="value" id="v-route-len">-</span>
          </div>
          <div class="row">
            <span class="label">CCTV (íšŒë‘ ë‚´)</span
            ><span class="value" id="v-cctv">-</span>
          </div>
          <div class="row">
            <span class="label">ë³´ì•ˆë“± (íšŒë‘ ë‚´)</span
            ><span class="value" id="v-lamp">-</span>
          </div>
        </div>

        <!-- ì ìˆ˜ ì‚°ì¶œ ê³¼ì • -->
        <div class="card">
          <h3>ğŸ”¬ ì ìˆ˜ ì‚°ì¶œ ê³¼ì •</h3>
          <div class="step">
            <span class="step-num">1</span
            ><span class="step-label"
              >ê²½ë¡œë¥¼ <b id="v-step-m">-</b>m ê°„ê²©ìœ¼ë¡œ ìƒ˜í”Œë§</span
            >
          </div>
          <div class="step">
            <span class="step-num">2</span
            ><span class="step-label"
              >CCTV ë°˜ê²½ <b id="v-cctv-r">-</b>m / ë³´ì•ˆë“± ë°˜ê²½
              <b id="v-lamp-r">-</b>m íšŒë‘ ìƒì„±</span
            >
          </div>
          <div class="step">
            <span class="step-num">3</span
            ><span class="step-label"
              >ìƒ˜í”Œ í¬ì¸íŠ¸ê°€ íšŒë‘ ë‚´ì— ìˆìœ¼ë©´
              <b style="color: #4caf50">ì»¤ë²„ë¨(ì´ˆë¡)</b>, ì•„ë‹ˆë©´
              <b style="color: #f44336">ë¯¸ì»¤ë²„(ë¹¨ê°•)</b></span
            >
          </div>
          <div class="step">
            <span class="step-num">4</span
            ><span class="step-label"
              ><b>ì•ˆì „ ì ìˆ˜ = ì´ˆë¡ í¬ì¸íŠ¸ / ì „ì²´ í¬ì¸íŠ¸ Ã— 100</b></span
            >
          </div>
        </div>

        <!-- ìˆ˜ì‹ -->
        <div class="card">
          <h3>ğŸ“ ì‚°ì¶œ ìˆ˜ì‹ (ë‹¨ìˆœí™”)</h3>
          <div class="formula">
            covered = ì´ˆë¡ ìƒ˜í”Œ í¬ì¸íŠ¸ ìˆ˜<br />
            total = ì „ì²´ ìƒ˜í”Œ í¬ì¸íŠ¸ ìˆ˜<br />
            <br />
            <span class="highlight">ì•ˆì „ ì ìˆ˜ = (covered / total) Ã— 100</span>
          </div>
        </div>

        <!-- ì„¸ë¶€ ì§€í‘œ -->
        <div class="card">
          <h3>ğŸ“ˆ ì„¸ë¶€ ì§€í‘œ</h3>
          <div class="row">
            <span class="label">ì»¤ë²„ëœ í¬ì¸íŠ¸ (ì´ˆë¡)</span
            ><span class="value" id="v-covered">-</span>
          </div>
          <div class="row">
            <span class="label">ë¯¸ì»¤ë²„ í¬ì¸íŠ¸ (ë¹¨ê°•)</span
            ><span class="value" id="v-uncovered">-</span>
          </div>
          <div class="row">
            <span class="label">ì „ì²´ ìƒ˜í”Œ í¬ì¸íŠ¸</span
            ><span class="value" id="v-total-points">-</span>
          </div>
          <div
            class="row"
            style="
              border-top: 1px solid #eee;
              padding-top: 6px;
              margin-top: 6px;
            "
          >
            <span class="label">ì»¤ë²„ë¦¬ì§€ ë¹„ìœ¨</span
            ><span class="value" id="v-coverage">-</span>
          </div>
          <div class="row">
            <span class="label">ìµœëŒ€ ê³µë°± êµ¬ê°„</span
            ><span class="value" id="v-gap">-</span>
          </div>
        </div>

        <!-- ì¸í”„ë¼ ì •ë³´ -->
        <div class="card">
          <h3>ğŸ—ï¸ ì¸í”„ë¼ ì •ë³´</h3>
          <div class="row">
            <span class="label">CCTV (íšŒë‘ ë‚´)</span
            ><span class="value" id="v-cctv-infra">-</span>
          </div>
          <div class="row">
            <span class="label">ë³´ì•ˆë“± (íšŒë‘ ë‚´)</span
            ><span class="value" id="v-lamp-infra">-</span>
          </div>
        </div>

        <!-- ë²”ë¡€ -->
        <div class="card">
          <h3>ğŸ—ºï¸ ì§€ë„ ë²”ë¡€</h3>
          <div class="legend-item">
            <div class="legend-line" style="background: #1565c0"></div>
            ì‚°ì±… ê²½ë¡œ
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #4caf50"></div>
            ìƒ˜í”Œ í¬ì¸íŠ¸ (ì»¤ë²„ë¨)
          </div>
          <div class="legend-item">
            <div class="legend-dot" style="background: #f44336"></div>
            ìƒ˜í”Œ í¬ì¸íŠ¸ (ë¯¸ì»¤ë²„)
          </div>
          <div class="legend-item">
            <div
              class="legend-dot"
              style="background: #ff9800; border: 2px solid #e65100"
            ></div>
            CCTV ìœ„ì¹˜
          </div>
          <div class="legend-item">
            <div
              class="legend-dot"
              style="background: #fdd835; border: 2px solid #f9a825"
            ></div>
            ë³´ì•ˆë“± ìœ„ì¹˜
          </div>
          <div class="legend-item">
            <div
              class="legend-line"
              style="
                background: rgba(255, 152, 0, 0.15);
                border: 1px dashed #ff9800;
              "
            ></div>
            CCTV íšŒë‘ (50m)
          </div>
          <div class="legend-item">
            <div
              class="legend-line"
              style="
                background: rgba(253, 216, 53, 0.15);
                border: 1px dashed #fdd835;
              "
            ></div>
            ë³´ì•ˆë“± íšŒë‘ (15m)
          </div>
        </div>
      </div>

      <!-- â”€â”€â”€ ì§€ë„ â”€â”€â”€ -->
      <div id="map-wrap">
        <div id="layer-controls">
          <b>ë ˆì´ì–´ í† ê¸€</b>
          <label><input type="checkbox" id="chk-route" checked /> ê²½ë¡œ</label>
          <label
            ><input type="checkbox" id="chk-sample" checked /> ìƒ˜í”Œ
            í¬ì¸íŠ¸</label
          >
          <label><input type="checkbox" id="chk-cctv" checked /> CCTV</label>
          <label><input type="checkbox" id="chk-lamp" checked /> ë³´ì•ˆë“±</label>
          <label
            ><input type="checkbox" id="chk-corridor-cctv" checked /> CCTV
            íšŒë‘</label
          >
          <label
            ><input type="checkbox" id="chk-corridor-lamp" checked /> ë³´ì•ˆë“±
            íšŒë‘</label
          >
          <label><input type="checkbox" id="chk-gap" /> ìµœëŒ€ ê³µë°± êµ¬ê°„</label>
        </div>
        <div id="map"></div>
      </div>
    </div>

    <!-- ì¹´ì¹´ì˜¤ë§µ SDK â€” YOUR_APP_KEY ë¥¼ êµì²´í•˜ì„¸ìš” -->
    <script
      type="text/javascript"
      src="//dapi.kakao.com/v2/maps/sdk.js?appkey=04bd479933893a7050c82bf667702a4b&libraries=drawing"
    ></script>
    <script>
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ê¸€ë¡œë²Œ ë³€ìˆ˜
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      let map;
      let DATA = null;

      // ë ˆì´ì–´ ê·¸ë£¹
      const layers = {
        route: [],
        sample: [],
        cctv: [],
        lamp: [],
        corridorCctv: [],
        corridorLamp: [],
        gap: [],
      };

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ìœ í‹¸
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function scoreColor(score) {
        if (score >= 70) return "#4caf50";
        if (score >= 40) return "#ff9800";
        return "#f44336";
      }

      function setVis(arr, visible) {
        arr.forEach((o) => o.setMap(visible ? map : null));
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ë°ì´í„° ë¡œë“œ & ë Œë”
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      async function init() {
        // ë°ì´í„° ë¡œë“œ
        const res = await fetch("safety_data.json");
        DATA = await res.json();

        // ì¹´ì¹´ì˜¤ë§µ ì´ˆê¸°í™”
        kakao.maps.load(() => {
          const container = document.getElementById("map");
          map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(DATA.center.lat, DATA.center.lng),
            level: 4,
          });

          drawAll();
          fillSidebar();
          bindCheckboxes();

          document.getElementById("loading").classList.add("hidden");
        });
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì§€ë„ì— ê·¸ë¦¬ê¸°
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function drawAll() {
        // 1) CCTV íšŒë‘ (ë„ë„› ëª¨ì–‘ - ê²½ë¡œ ì£¼ë³€ë§Œ)
        if (DATA.debug.corridors && DATA.debug.corridors.cctv) {
          const path = DATA.debug.corridors.cctv.map(
            (c) => new kakao.maps.LatLng(c.lat, c.lng),
          );
          // ì™¸ê³½ì„ ë§Œ í‘œì‹œ (fill ì—†ìŒ)
          const poly = new kakao.maps.Polygon({
            path: path,
            strokeWeight: 2,
            strokeColor: "#ff9800",
            strokeOpacity: 0.6,
            strokeStyle: "dash",
            fillColor: "#ff9800",
            fillOpacity: 0, // íˆ¬ëª…í•˜ê²Œ
          });
          poly.setMap(map);
          layers.corridorCctv.push(poly);

          // ë°˜íˆ¬ëª… ì˜ì—­ì„ ìœ„í•œ polyline (ê²½ë¡œë¥¼ ë”°ë¼ ë‘ê»ê²Œ)
          const routePath = DATA.route.map(
            (c) => new kakao.maps.LatLng(c.lat, c.lng),
          );
          const thickLine = new kakao.maps.Polyline({
            path: routePath,
            strokeWeight: 100, // 50m * 2 = 100m ë„ˆë¹„ (ëŒ€ëµ)
            strokeColor: "#ff9800",
            strokeOpacity: 0.08,
            strokeStyle: "solid",
          });
          thickLine.setMap(map);
          layers.corridorCctv.push(thickLine);
        }

        // 2) ë³´ì•ˆë“± íšŒë‘ (ë„ë„› ëª¨ì–‘)
        if (DATA.debug.corridors && DATA.debug.corridors.lamp) {
          const path = DATA.debug.corridors.lamp.map(
            (c) => new kakao.maps.LatLng(c.lat, c.lng),
          );
          // ì™¸ê³½ì„ ë§Œ í‘œì‹œ
          const poly = new kakao.maps.Polygon({
            path: path,
            strokeWeight: 2,
            strokeColor: "#fdd835",
            strokeOpacity: 0.6,
            strokeStyle: "dash",
            fillColor: "#fdd835",
            fillOpacity: 0, // íˆ¬ëª…í•˜ê²Œ
          });
          poly.setMap(map);
          layers.corridorLamp.push(poly);

          // ë°˜íˆ¬ëª… ì˜ì—­
          const routePath = DATA.route.map(
            (c) => new kakao.maps.LatLng(c.lat, c.lng),
          );
          const thickLine = new kakao.maps.Polyline({
            path: routePath,
            strokeWeight: 30, // 15m * 2 = 30m ë„ˆë¹„ (ëŒ€ëµ)
            strokeColor: "#fdd835",
            strokeOpacity: 0.1,
            strokeStyle: "solid",
          });
          thickLine.setMap(map);
          layers.corridorLamp.push(thickLine);
        }

        // 3) ë³´ì•ˆë“± ë§ˆì»¤
        DATA.infra_lamp.forEach((p) => {
          const circle = new kakao.maps.Circle({
            center: new kakao.maps.LatLng(p.lat, p.lng),
            radius: 3,
            strokeWeight: 1,
            strokeColor: "#f9a825",
            strokeOpacity: 0.8,
            fillColor: "#fdd835",
            fillOpacity: 0.7,
          });
          circle.setMap(map);
          layers.lamp.push(circle);
        });

        // 4) CCTV ë§ˆì»¤
        DATA.infra_cctv.forEach((p) => {
          const circle = new kakao.maps.Circle({
            center: new kakao.maps.LatLng(p.lat, p.lng),
            radius: 4,
            strokeWeight: 1.5,
            strokeColor: "#e65100",
            strokeOpacity: 0.9,
            fillColor: "#ff9800",
            fillOpacity: 0.8,
          });
          circle.setMap(map);
          layers.cctv.push(circle);
        });

        // 5) ê²½ë¡œ í´ë¦¬ë¼ì¸
        const routePath = DATA.route.map(
          (c) => new kakao.maps.LatLng(c.lat, c.lng),
        );
        const routeLine = new kakao.maps.Polyline({
          path: routePath,
          strokeWeight: 5,
          strokeColor: "#1565c0",
          strokeOpacity: 0.9,
          strokeStyle: "solid",
        });
        routeLine.setMap(map);
        layers.route.push(routeLine);

        // ì‹œì‘ì  ë§ˆì»¤
        const startMarker = new kakao.maps.Marker({
          position: routePath[0],
          map: map,
        });
        const startInfo = new kakao.maps.InfoWindow({
          content:
            '<div style="padding:5px;font-size:12px;font-weight:bold;">ğŸš¶ ì¶œë°œ/ë„ì°©</div>',
        });
        startInfo.open(map, startMarker);
        layers.route.push(startMarker);

        // 6) ìƒ˜í”Œ í¬ì¸íŠ¸
        if (DATA.debug.sample_points) {
          DATA.debug.sample_points.forEach((sp, idx) => {
            const covered = sp.covered === 1;
            const circle = new kakao.maps.Circle({
              center: new kakao.maps.LatLng(sp.lat, sp.lng),
              radius: 2.5,
              strokeWeight: 1.5,
              strokeColor: covered ? "#2e7d32" : "#c62828",
              strokeOpacity: 1,
              fillColor: covered ? "#4caf50" : "#f44336",
              fillOpacity: 0.9,
            });
            circle.setMap(map);
            layers.sample.push(circle);
          });

          // 7) ìµœëŒ€ ê³µë°± êµ¬ê°„ í‘œì‹œ
          drawMaxGap();
        }
      }

      function drawMaxGap() {
        if (!DATA.debug.sample_points) return;

        const sp = DATA.debug.sample_points;
        // ìµœëŒ€ ê³µë°± êµ¬ê°„ ì°¾ê¸°
        let maxGapStart = -1,
          maxGapEnd = -1,
          maxLen = 0;
        let curStart = -1,
          curLen = 0;

        for (let i = 0; i < sp.length; i++) {
          if (sp[i].covered === 0) {
            if (curStart < 0) curStart = i;
            if (i > 0) {
              const d = haversine(
                sp[i - 1].lat,
                sp[i - 1].lng,
                sp[i].lat,
                sp[i].lng,
              );
              curLen += d;
            }
          } else {
            if (curLen > maxLen) {
              maxLen = curLen;
              maxGapStart = curStart;
              maxGapEnd = i;
            }
            curStart = -1;
            curLen = 0;
          }
        }
        if (curLen > maxLen) {
          maxLen = curLen;
          maxGapStart = curStart;
          maxGapEnd = sp.length - 1;
        }

        if (maxGapStart >= 0 && maxGapEnd > maxGapStart) {
          const gapPath = [];
          for (let i = maxGapStart; i <= maxGapEnd; i++) {
            gapPath.push(new kakao.maps.LatLng(sp[i].lat, sp[i].lng));
          }
          if (gapPath.length > 1) {
            const gapLine = new kakao.maps.Polyline({
              path: gapPath,
              strokeWeight: 8,
              strokeColor: "#f44336",
              strokeOpacity: 0.5,
              strokeStyle: "shortdash",
            });
            // ê¸°ë³¸ ìˆ¨ê¹€ (ì²´í¬í•´ì•¼ ë³´ì„)
            layers.gap.push(gapLine);
          }
        }
      }

      function haversine(lat1, lon1, lat2, lon2) {
        const R = 6371000;
        const dLat = ((lat2 - lat1) * Math.PI) / 180;
        const dLon = ((lon2 - lon1) * Math.PI) / 180;
        const a =
          Math.sin(dLat / 2) ** 2 +
          Math.cos((lat1 * Math.PI) / 180) *
            Math.cos((lat2 * Math.PI) / 180) *
            Math.sin(dLon / 2) ** 2;
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì‚¬ì´ë“œë°” ì±„ìš°ê¸°
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function fillSidebar() {
        const f = DATA.features;
        const p = DATA.params;
        const score = DATA.score;

        // í—¤ë” ë°°ì§€
        document.getElementById("score-badge").textContent = score + " ì ";
        document.getElementById("score-badge").style.background =
          scoreColor(score);

        // ê²Œì´ì§€
        const fill = document.getElementById("gauge-fill");
        fill.style.background = `linear-gradient(90deg, ${scoreColor(score)}, ${scoreColor(score)}dd)`;
        setTimeout(() => {
          fill.style.width = score + "%";
        }, 200);
        document.getElementById("gauge-text").textContent = score + "ì ";

        // ê¸°ë³¸ ìˆ˜ì¹˜
        document.getElementById("v-route-len").textContent =
          f.route_len_m.toFixed(1) + " m";
        document.getElementById("v-cctv").textContent = f.cctv_count + "ëŒ€";
        document.getElementById("v-lamp").textContent = f.lamp_count + "ê°œ";

        // íŒŒë¼ë¯¸í„°
        document.getElementById("v-step-m").textContent = p.sample_step_m;
        document.getElementById("v-cctv-r").textContent = p.cctv_radius_m;
        document.getElementById("v-lamp-r").textContent = p.lamp_radius_m;

        // ì„¸ë¶€ ì§€í‘œ - ë‹¨ìˆœí™”
        const covered = f.covered_points || 0;
        const total = f.total_points || 0;
        const uncovered = total - covered;

        document.getElementById("v-covered").textContent = covered + "ê°œ";
        document.getElementById("v-uncovered").textContent = uncovered + "ê°œ";
        document.getElementById("v-total-points").textContent = total + "ê°œ";
        document.getElementById("v-coverage").textContent =
          (f.coverage_score * 100).toFixed(1) + "%";
        document.getElementById("v-gap").textContent =
          f.max_gap_m.toFixed(1) + " m";

        // ì¸í”„ë¼ ì •ë³´
        document.getElementById("v-cctv-infra").textContent =
          f.cctv_count + "ëŒ€";
        document.getElementById("v-lamp-infra").textContent =
          f.lamp_count + "ê°œ";
      }

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // ì²´í¬ë°•ìŠ¤ ë°”ì¸ë”©
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      function bindCheckboxes() {
        const mapping = {
          "chk-route": "route",
          "chk-sample": "sample",
          "chk-cctv": "cctv",
          "chk-lamp": "lamp",
          "chk-corridor-cctv": "corridorCctv",
          "chk-corridor-lamp": "corridorLamp",
          "chk-gap": "gap",
        };

        Object.entries(mapping).forEach(([id, key]) => {
          const el = document.getElementById(id);
          el.addEventListener("change", () => {
            setVis(layers[key], el.checked);
          });
          // ì´ˆê¸° ìƒíƒœ ë™ê¸°í™”
          if (!el.checked) setVis(layers[key], false);
        });
      }

      // â”€â”€ í˜ì´ì§€ ë¡œë“œ â”€â”€
      window.onload = function () {
        if (typeof kakao === "undefined") {
          alert(
            "ì¹´ì¹´ì˜¤ë§µ API í‚¤ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”.\nsafety_visualization.html íŒŒì¼ì˜ YOUR_APP_KEYë¥¼ êµì²´í•˜ì„¸ìš”.",
          );
          document.getElementById("loading").textContent = "API í‚¤ í•„ìš”!";
          return;
        }
        init();
      };
    </script>
  </body>
</html>
