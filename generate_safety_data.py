"""
역삼역 중심 ~1km 순환 산책경로에 대해 safety_score를 계산하고
시각화에 필요한 모든 데이터를 JSON으로 출력한다.
"""
from __future__ import annotations

import json
import math
import os
import sys

# safety_score.py 가 같은 폴더에 있으므로 경로 추가
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from safety_score import (
    SafetyParams,
    compute_safety_score,
    load_cctv_points,
    load_lamp_points,
)

# GPS_Art_Route_Test generate_routes 사용
ROOT = os.path.abspath(os.path.join(os.path.dirname(__file__), ".."))
sys.path.insert(0, os.path.join(ROOT, "GPS_Art_Route_Test"))
from generate_routes import generate_routes

# ── 1. 실제 경로 생성 (GPS_Art_Route_Test) ──────────────────────────
# 시작점(역삼역 근처 기본값)
CENTER_LAT = 37.50068
CENTER_LNG = 127.03647
TARGET_DISTANCE_KM = float(os.environ.get("TARGET_DISTANCE_KM", "1.0"))
FAST_MODE = os.environ.get("FAST_MODE", "0") == "1"

SVG_PATH = os.environ.get(
    "SVG_PATH",
    (
        "M 204.33333333333331 89.66666158040363 "
        "L 204.33333333333331 89.66666158040363 "
        "L 199.66666666666666 96.33332824707031 "
        "L 195 103.66666158040363 "
        "L 190 110.66666158040363 "
        "L 185 118.33332824707031 "
        "L 180.33333333333331 125.66666158040363 "
        "L 176 132.66666158040363 "
        "L 172.33333333333331 138.66666158040363 "
        "L 169 143.66666158040363 "
        "L 166.66666666666666 147.99999491373694 "
        "L 165.66666666666666 149.99999491373694 "
        "L 165.66666666666666 150.3333282470703 "
        "L 165.33333333333331 150.3333282470703 "
        "L 163.33333333333331 150.3333282470703 "
        "L 159.66666666666666 150.3333282470703 "
        "L 154.66666666666666 150.3333282470703 "
        "L 149 150.3333282470703 "
        "L 143.33333333333331 150.3333282470703 "
        "L 138.66666666666666 150.3333282470703 "
        "L 134.33333333333331 150.3333282470703 "
        "L 130 150.3333282470703 "
        "L 126 150.3333282470703 "
        "L 122 150.3333282470703 "
        "L 118.33333333333331 150.3333282470703 "
        "L 114.66666666666666 150.3333282470703 "
        "L 111.33333333333331 150.3333282470703 "
        "L 108 150.3333282470703 "
        "L 104 150.3333282470703 "
        "L 99.66666666666666 150.3333282470703 "
        "L 95 150.66666158040363 "
        "L 89.33333333333333 152.3333282470703 "
        "L 84.33333333333333 154.66666158040363 "
        "L 79.33333333333333 157.3333282470703 "
        "L 74 159.66666158040363 "
        "L 68.66666666666666 163.3333282470703 "
        "L 62.66666666666666 166.99999491373694 "
        "L 56.66666666666666 171.66666158040363 "
        "L 51 175.99999491373694 "
        "L 46.33333333333333 180.3333282470703 "
        "L 41.66666666666666 183.99999491373694 "
        "L 38 187.99999491373694 "
        "L 34 191.66666158040363 "
        "L 31 196.3333282470703 "
        "L 27.666666666666664 200.66666158040363 "
        "L 25.33333333333333 205.3333282470703 "
        "L 23 210.66666158040363 "
        "L 21.33333333333333 215.66666158040363 "
        "L 19.666666666666664 220.99999491373694 "
        "L 18.666666666666664 226.66666158040363 "
        "L 18.33333333333333 232.3333282470703 "
        "L 18 237.66666158040363 "
        "L 17.666666666666664 242.99999491373694 "
        "L 17.666666666666664 249.3333282470703 "
        "L 17.666666666666664 255.66666158040363 "
        "L 17.666666666666664 262.3333282470703 "
        "L 17.666666666666664 269.3333282470703 "
        "L 18.33333333333333 276.3333282470703 "
        "L 20 282.3333282470703 "
        "L 22.33333333333333 288.3333282470703 "
        "L 25 292.99999491373694 "
        "L 28 297.3333282470703 "
        "L 31.666666666666664 301.66666158040357 "
        "L 35.33333333333333 305.3333282470703 "
        "L 39.666666666666664 308.66666158040357 "
        "L 43.33333333333333 311.66666158040357 "
        "L 47.66666666666666 313.99999491373694 "
        "L 51.33333333333333 315.99999491373694 "
        "L 55.33333333333333 317.66666158040357 "
        "L 59.33333333333333 318.99999491373694 "
        "L 63.66666666666666 319.99999491373694 "
        "L 68 319.99999491373694 "
        "L 72.66666666666666 320.3333282470703 "
        "L 77.66666666666666 320.3333282470703 "
        "L 82.33333333333333 320.3333282470703 "
        "L 87.33333333333333 320.3333282470703 "
        "L 91.66666666666666 320.3333282470703 "
        "L 96 320.3333282470703 "
        "L 100 320.3333282470703 "
        "L 103.33333333333333 319.99999491373694 "
        "L 106.66666666666666 319.66666158040357 "
        "L 110 318.66666158040357 "
        "L 113 317.3333282470703 "
        "L 116.33333333333331 316.3333282470703 "
        "L 119.33333333333331 315.3333282470703 "
        "L 122.33333333333331 314.3333282470703 "
        "L 125.33333333333331 313.3333282470703 "
        "L 127.66666666666666 312.3333282470703 "
        "L 130.33333333333331 311.3333282470703 "
        "L 133 309.99999491373694 "
        "L 135.33333333333331 308.3333282470703 "
        "L 138 306.3333282470703 "
        "L 140.66666666666666 304.66666158040357 "
        "L 142.66666666666666 302.99999491373694 "
        "L 145 300.66666158040357 "
        "L 147.33333333333331 298.3333282470703 "
        "L 149.66666666666666 295.99999491373694 "
        "L 151.66666666666666 292.99999491373694 "
        "L 154.33333333333331 290.3333282470703 "
        "L 157.33333333333331 287.3333282470703 "
        "L 160.66666666666666 282.99999491373694 "
        "L 164.66666666666666 278.6666615804036 "
        "L 167.66666666666666 273.99999491373694 "
        "L 171 270.3333282470703 "
        "L 173.66666666666666 266.6666615804036 "
        "L 176 263.6666615804036 "
        "L 178 260.3333282470703 "
        "L 179.66666666666666 257.6666615804036 "
        "L 180.66666666666666 254.3333282470703 "
        "L 181.66666666666666 251.3333282470703 "
        "L 183 247.99999491373694 "
        "L 184.33333333333331 244.66666158040363 "
        "L 185.66666666666666 241.3333282470703 "
        "L 187 237.66666158040363 "
        "L 188.33333333333331 233.99999491373694 "
        "L 189.33333333333331 229.99999491373694 "
        "L 190.66666666666666 226.3333282470703 "
        "L 191.66666666666666 222.3333282470703 "
        "L 192.33333333333331 218.99999491373694 "
        "L 193 215.3333282470703 "
        "L 193.66666666666666 211.99999491373694 "
        "L 193.66666666666666 209.66666158040363 "
        "L 193.66666666666666 207.3333282470703 "
        "L 193.66666666666666 204.99999491373694 "
        "L 193.66666666666666 202.99999491373694 "
        "L 193.66666666666666 200.3333282470703 "
        "L 194 198.66666158040363 "
        "L 194 197.3333282470703 "
        "L 194.33333333333331 196.66666158040363 "
        "L 194.33333333333331 196.3333282470703 "
        "L 194.33333333333331 195.99999491373694 "
        "L 194.33333333333331 195.66666158040363 "
        "L 194.33333333333331 195.3333282470703 "
        "L 194.33333333333331 194.99999491373694 "
        "L 194.66666666666666 194.66666158040363 "
        "L 194.66666666666666 194.3333282470703 "
        "L 194.66666666666666 193.99999491373694 "
        "L 194.66666666666666 193.66666158040363 "
        "L 194.66666666666666 193.3333282470703 "
        "L 195 193.3333282470703 "
        "L 195.33333333333331 193.3333282470703 "
        "L 195.66666666666666 193.3333282470703 "
        "L 196.66666666666666 193.3333282470703 "
        "L 199.33333333333331 193.3333282470703 "
        "L 203 194.66666158040363 "
        "L 207.33333333333331 196.3333282470703 "
        "L 211.66666666666666 197.3333282470703 "
        "L 216.33333333333331 198.99999491373694 "
        "L 220.66666666666666 200.66666158040363 "
        "L 225.33333333333331 202.3333282470703 "
        "L 229.33333333333331 203.99999491373694 "
        "L 233.66666666666663 205.3333282470703 "
        "L 237.66666666666663 206.66666158040363 "
        "L 241.66666666666663 207.99999491373694 "
        "L 245.33333333333331 208.99999491373694 "
        "L 248.66666666666663 209.99999491373694 "
        "L 251.66666666666663 209.99999491373694 "
        "L 254.33333333333331 209.99999491373694 "
        "L 257.3333333333333 209.99999491373694 "
        "L 260 209.99999491373694 "
        "L 263 209.99999491373694 "
        "L 265.3333333333333 209.99999491373694 "
        "L 266.66666666666663 209.99999491373694 "
        "L 267.3333333333333 209.99999491373694 "
        "L 267.3333333333333 208.3333282470703 "
        "L 267.3333333333333 204.99999491373694 "
        "L 266.66666666666663 200.66666158040363 "
        "L 265 195.99999491373694 "
        "L 263 190.3333282470703 "
        "L 260.3333333333333 184.99999491373694 "
        "L 257.66666666666663 178.99999491373694 "
        "L 254.66666666666663 172.99999491373694 "
        "L 251.33333333333331 167.3333282470703 "
        "L 248.33333333333331 161.99999491373694 "
        "L 244.66666666666663 156.66666158040363 "
        "L 241.33333333333331 150.99999491373694 "
        "L 237.66666666666663 145.3333282470703 "
        "L 234.33333333333331 139.99999491373694 "
        "L 231.33333333333331 134.66666158040363 "
        "L 228.33333333333331 130.3333282470703 "
        "L 226.66666666666666 126.66666158040363 "
        "L 225.33333333333331 123.33332824707031 "
        "L 224.66666666666666 120.33332824707031 "
        "L 224.33333333333331 117.66666158040363 "
        "L 223.66666666666666 114.99999491373694 "
        "L 223.33333333333331 112.33332824707031 "
        "L 222.66666666666666 109.66666158040363 "
        "L 222 106.66666158040363 "
        "L 221.33333333333331 103.66666158040363 "
        "L 220.66666666666666 100.33332824707031 "
        "L 219.66666666666666 97.33332824707031 "
        "L 218.66666666666666 94.33332824707031 "
        "L 217.66666666666666 91.33332824707031 "
        "L 216.33333333333331 88.99999491373694 "
        "L 215 86.99999491373694 "
        "L 213.66666666666666 85.33332824707031 "
        "L 212.66666666666666 84.33332824707031 "
        "L 211.66666666666666 83.66666158040363 "
        "L 211.33333333333331 83.33332824707031 "
        "L 210.66666666666666 82.99999491373694 "
        "L 210.33333333333331 82.99999491373694 "
        "L 210 82.99999491373694 "
        "L 209.66666666666666 82.99999491373694 "
        "L 209.33333333333331 82.99999491373694 "
        "L 209.33333333333331 82.66666158040363 "
        "L 209.33333333333331 82.33332824707031"
    )

    )

# ── 2. 데이터 로드 ─────────────────────────────────────────────────
HERE = os.path.dirname(os.path.abspath(__file__))
CCTV_CSV = os.path.join(HERE, "Seoul_CCTV.csv")
LAMP_CSV = os.path.join(HERE, "서울특별시_강남구_보안등정보_20250103.csv")

print(f"[INFO] CCTV CSV : {CCTV_CSV}  (exists={os.path.exists(CCTV_CSV)})")
print(f"[INFO] LAMP CSV : {LAMP_CSV}  (exists={os.path.exists(LAMP_CSV)})")

cctv_raw = load_cctv_points(CCTV_CSV)
lamp_raw = load_lamp_points(LAMP_CSV)

print(f"[INFO] CCTV 데이터 수: {len(cctv_raw)}")
print(f"[INFO] 보안등 데이터 수: {len(lamp_raw)}")

# ── 3. 경로 주변(±0.01도 ≈ 1.1km)만 필터링하여 속도 향상 ──────────
MARGIN = 0.008  # 약 800m
min_lat = CENTER_LAT - MARGIN
max_lat = CENTER_LAT + MARGIN
min_lng = CENTER_LNG - MARGIN
max_lng = CENTER_LNG + MARGIN

cctv_near = [
    p for p in cctv_raw
    if min_lat <= p["lat"] <= max_lat and min_lng <= p["lon"] <= max_lng
]
lamp_near = [
    p for p in lamp_raw
    if min_lat <= p["lat"] <= max_lat and min_lng <= p["lon"] <= max_lng
]

print(f"[INFO] 경로 주변 CCTV: {len(cctv_near)}")
print(f"[INFO] 경로 주변 보안등: {len(lamp_near)}")

# infra_points 합치기 (type 키 보존)
infra_points = cctv_near + lamp_near

# ── 4. 실제 경로 생성 ──────────────────────────────────────────────
result = generate_routes(
    start_lat=CENTER_LAT,
    start_lon=CENTER_LNG,
    svg_path=SVG_PATH,
    target_distance_km=TARGET_DISTANCE_KM,
    mode="custom",
    enable_rotation=not FAST_MODE,
    rotation_angles=[0] if FAST_MODE else None,
    length_feedback=False if FAST_MODE else True,
)
if not result.get("routes"):
    raise SystemExit("경로 생성 실패: routes가 비어있습니다.")

best_route = min(result["routes"], key=lambda r: r.get("similarity_score", 1e9))
route_coords = best_route.get("coordinates", [])
print(f"[INFO] 경로 좌표 수: {len(route_coords)}")

# ── 5. 안전점수 계산 (debug=True 로 상세 데이터) ──────────────────
params = SafetyParams()
result = compute_safety_score(
    route_coords=route_coords,
    infra_points=infra_points,
    params=params,
    debug=True,
)

print(f"\n{'='*50}")
print(f"  안전 점수: {result['score']} / 100")
print(f"{'='*50}")
print(f"  경로 길이      : {result['features']['route_len_m']:.1f} m")
print(f"  CCTV 수 (회랑) : {result['features']['cctv_count']}")
print(f"  보안등 수(회랑) : {result['features']['lamp_count']}")
print(f"  밀도 점수       : {result['features']['density_score']:.4f}")
print(f"  커버리지 점수   : {result['features']['coverage_score']:.4f}")
print(f"  최대 공백(m)    : {result['features']['max_gap_m']:.1f}")
print(f"  공백 페널티     : {result['features']['gap_penalty']:.4f}")
print(f"{'='*50}\n")

# ── 6. JSON 출력 ───────────────────────────────────────────────────
output = {
    "center": {"lat": CENTER_LAT, "lng": CENTER_LNG},
    "route": route_coords,
    "score": result["score"],
    "raw01": result["raw01"],
    "features": result["features"],
    "params": {
        "sample_step_m": params.sample_step_m,
        "lamp_radius_m": params.lamp_radius_m,
        "cctv_radius_m": params.cctv_radius_m,
        "density_k_per_km": params.density_k_per_km,
        "gap_G_m": params.gap_G_m,
        "w_density": params.w_density,
        "w_coverage": params.w_coverage,
        "w_gap": params.w_gap,
        "rescale_max": params.rescale_max,
    },
    "debug": result.get("debug", {}),
    "infra_cctv": [{"lat": p["lat"], "lng": p["lon"]} for p in cctv_near],
    "infra_lamp": [{"lat": p["lat"], "lng": p["lon"]} for p in lamp_near],
}

out_path = os.path.join(HERE, "safety_data.json")
with open(out_path, "w", encoding="utf-8") as f:
    json.dump(output, f, ensure_ascii=False, indent=2)

print(f"[OK] {out_path} 저장 완료  ({os.path.getsize(out_path):,} bytes)")
